'use strict';
const { assert } = require('chai');
const ErrorParser = require('../../../apps/monitoring/errorParser');
const _ = require('lodash');
const errorFull = '{\n  "date": "Tue Mar 28 2017 13:24:49 GMT+0300 (EEST)",\n  "process": {\n    "pid": 5403,\n    "uid": 1001,\n    "gid": 1001,\n    "cwd": "/home/dainisl/code/Kliiko",\n    "execPath": "/usr/bin/nodejs",\n    "version": "v6.10.1",\n    "argv": [\n      "/usr/bin/nodejs",\n      "/home/dainisl/code/Kliiko/node_modules/pm2/lib/ProcessContainer.js"\n    ],\n    "memoryUsage": {\n      "rss": 150228992,\n      "heapTotal": 116846592,\n      "heapUsed": 76218712,\n      "external": 3075869\n    }\n  },\n  "os": {\n    "loadavg": [\n      2.5556640625,\n      2.4375,\n      2.33056640625\n    ],\n    "uptime": 5126\n  },\n  "trace": [\n    {\n      "column": 12,\n      "file": "/home/dainisl/code/Kliiko/routes/root/index.js",\n      "function": null,\n      "line": 36,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 5,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/layer.js",\n      "function": "Layer.handle [as handle_request]",\n      "line": 95,\n      "method": "handle [as handle_request]",\n      "native": false\n    },\n    {\n      "column": 13,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "trim_prefix",\n      "line": 312,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 7,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": null,\n      "line": 280,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 12,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "Function.process_params",\n      "line": 330,\n      "method": "process_params",\n      "native": false\n    },\n    {\n      "column": 10,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "next",\n      "line": 271,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 3,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "Function.handle",\n      "line": 176,\n      "method": "handle",\n      "native": false\n    },\n    {\n      "column": 12,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "router",\n      "line": 46,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 5,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/layer.js",\n      "function": "Layer.handle [as handle_request]",\n      "line": 95,\n      "method": "handle [as handle_request]",\n      "native": false\n    },\n    {\n      "column": 13,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "trim_prefix",\n      "line": 312,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 7,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": null,\n      "line": 280,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 12,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "Function.process_params",\n      "line": 330,\n      "method": "process_params",\n      "native": false\n    },\n    {\n      "column": 10,\n      "file": "/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js",\n      "function": "next",\n      "line": 271,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 9,\n      "file": "/home/dainisl/code/Kliiko/middleware/subdomain.js",\n      "function": null,\n      "line": 87,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 7,\n      "file": "/home/dainisl/code/Kliiko/middleware/subdomain.js",\n      "function": null,\n      "line": 71,\n      "method": null,\n      "native": false\n    },\n    {\n      "column": 7,\n      "file": "/home/dainisl/code/Kliiko/middleware/subdomain.js",\n      "function": "",\n      "line": 59,\n      "method": null,\n      "native": false\n    }\n  ],\n  "stack": [\n    "TypeError: Cannot read property \'t\' of undefined",\n    "    at /home/dainisl/code/Kliiko/routes/root/index.js:36:12",\n    "    at Layer.handle [as handle_request] (/home/dainisl/code/Kliiko/node_modules/express/lib/router/layer.js:95:5)",\n    "    at trim_prefix (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:312:13)",\n    "    at /home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:280:7",\n    "    at Function.process_params (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:330:12)",\n    "    at next (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:271:10)",\n    "    at Function.handle (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:176:3)",\n    "    at router (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:46:12)",\n    "    at Layer.handle [as handle_request] (/home/dainisl/code/Kliiko/node_modules/express/lib/router/layer.js:95:5)",\n    "    at trim_prefix (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:312:13)",\n    "    at /home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:280:7",\n    "    at Function.process_params (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:330:12)",\n    "    at next (/home/dainisl/code/Kliiko/node_modules/express/lib/router/index.js:271:10)",\n    "    at /home/dainisl/code/Kliiko/middleware/subdomain.js:87:9",\n    "    at /home/dainisl/code/Kliiko/middleware/subdomain.js:71:7",\n    "    at Model.<anonymous> (/home/dainisl/code/Kliiko/middleware/subdomain.js:59:7)"\n  ],\n  "req": {\n    "url": "/favicon.ico",\n    "headers": {\n      "host": "admin.focus.com:8080",\n      "connection": "keep-alive",\n      "pragma": "no-cache",\n      "cache-control": "no-cache",\n      "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.110 Safari/537.36",\n      "accept": "image/webp,image/*,*/*;q=0.8",\n      "referer": "http://admin.focus.com:8080/logout",\n      "accept-encoding": "gzip, deflate, sdch",\n      "accept-language": "lv-LV,lv;q=0.8,en-US;q=0.6,en;q=0.4",\n      "cookie": "mp_1bdde8dd9995a8a636a094ed234647ec_mixpanel=%7B%22distinct_id%22%3A%20%2215ac6baba150-0245e0aa396871-142e110d-1fa400-15ac6baba163c5%22%2C%22%24initial_referrer%22%3A%20%22http%3A%2F%2Finsider.focus.com%3A8080%2Flogin%22%2C%22%24initial_referring_domain%22%3A%20%22insider.focus.com%3A8080%22%7D; mp_mixpanel__c=0; dev=s%3AIqZk-LBPDoPkFzZ9HYCPEqWlWG9hcE-n.5H9Zas1z5O4zr5XuEWIdruigI6uAYJAC9c9Vs%2BmKxD8"\n    },\n    "method": "GET",\n    "httpVersion": "1.1",\n    "originalUrl": "/favicon.ico",\n    "query": {}\n  },\n  "currentResources": {\n    "accountUser": {\n      "id": 1,\n      "role": "admin"\n    },\n    "account": {\n      "id": 1,\n      "name": "admin",\n      "subdomain": "admin",\n      "admin": true\n    },\n    "user": {\n      "id": 1,\n      "email": "admin@insider.com",\n      "selectedPlanOnRegistration": null\n    }\n  },\n  "application": "klzii-dashboard",\n  "level": "error",\n  "message": "middlewareError"\n}\n'
const errorStackOnly = '\nYou have triggered an unhandledRejection, you may have forgotten to catch a Promise rejection:\nTypeError: Cannot read property \'SubscriptionPreference\' of null\n    at Model.<anonymous> (/home/dainisl/code/Kliiko/services/validators/session.js:62:53)\n    at Model.tryCatcher (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/util.js:16:23)\n    at Promise._settlePromiseFromHandler (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:510:31)\n    at Promise._settlePromise (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:567:18)\n    at Promise._settlePromise0 (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:612:10)\n    at Promise._settlePromises (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:691:18)\n    at Promise._fulfill (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:636:18)\n    at Promise._resolveCallback (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:431:57)\n    at Promise._settlePromiseFromHandler (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:522:17)\n    at Promise._settlePromise (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:567:18)\n    at Promise._settlePromise0 (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:612:10)\n    at Promise._settlePromises (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:691:18)\n    at Promise._fulfill (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:636:18)\n    at MappingPromiseArray.PromiseArray._resolve (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise_array.js:125:19)\n    at MappingPromiseArray._promiseFulfilled (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/map.js:101:18)\n    at Promise._settlePromise (/home/dainisl/code/Kliiko/node_modules/bluebird/js/release/promise.js:572:26)\n'

const requiredKeys = ['date', 'process', 'os', 'trace', 'stack', 'currentResources', 'application', 'level', 'message']

describe('Error parser', () => {
    it("parse full error", () => {
        let error = ErrorParser.parse(errorFull);
        let keys = Object.keys(error)
        assert.isTrue(requiredKeys.every((k) => { return keys.indexOf(k) > -1}))
    })
    it("parse  Stack Only", () => {
        let error = ErrorParser.parse(errorStackOnly);
        let keys = Object.keys(error)
        assert.isTrue(requiredKeys.every((k) => { return keys.indexOf(k) > -1}))
    })
})